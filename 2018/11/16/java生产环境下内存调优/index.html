
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BELONG&#39;s Blog</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="belongapp,"> 
    <meta name="description" content="专注于后端开发,"> 
    <meta name="author" content="BELONG"> 
    <link rel="alternative" href="atom.xml" title="BELONG&#39;s Blog" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 






    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">



    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?2c17dd32817c94173b19c2a392bb97e9";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
 <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "4acee80f"
    });
  daovoice('update');
  </script>




</head>

<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">java生产环境内存调优</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">java生产环境内存调优</h1>
        <div class="stuff">
            <span>十一月 16, 2018</span>
            

            <span id="busuanzi_container_page_pv">
   本文总阅读量<span id="busuanzi_value_page_pv"></span>次
</span>
        </div>
        <div class="content markdown">
            <h4 id="1-JVM的参数类型"><a href="#1-JVM的参数类型" class="headerlink" title="1.JVM的参数类型"></a>1.JVM的参数类型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">标准参数（各版本中保持稳定）</div><div class="line">-help</div><div class="line">-server -client</div><div class="line">-version -showversion</div><div class="line">-cp -classpath</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X 参数（非标准化参数）</div><div class="line">-Xint：解释执行</div><div class="line">-Xcomp：第一次使用就编译成本地代码</div><div class="line">-Xmixed：混合模式，JVM 自己决定是否编译成本地代码</div></pre></td></tr></table></figure>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">java -version（默认是混合模式）</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.40-b25, mixed mode)</div><div class="line">java -Xint -version</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.40-b25, interpreted mode)</div></pre></td></tr></table></figure></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">XX 参数（非标准化参数）</div><div class="line">主要用于 JVM调优和 debug</div><div class="line">Boolean类型（+-）</div><div class="line">格式：-XX:[+-]&lt;name&gt;表示启用或禁用 name 属性</div><div class="line">如：-XX:+UseConcMarkSweepGC（启用cms垃圾收集器）</div><div class="line">-XX:+UseG1GC（启用G1垃圾收集器）</div><div class="line">非Boolean类型（key-value）（带=的）</div><div class="line">格式：-XX:&lt;name&gt;=&lt;value&gt;表示 name 属性的值是 value</div><div class="line">如：-XX:MaxGCPauseMillis=500（GC最大停用时间）</div><div class="line">-xx:GCTimeRatio=19</div><div class="line">-Xmx -Xms属于 XX 参数</div><div class="line">-Xms 等价于-XX:InitialHeapSize（初始化堆大小）</div><div class="line">-Xmx 等价于-XX:MaxHeapSize    (最大堆大小)</div><div class="line">-xss 等价于-XX:ThreadStackSize（线程堆栈）</div><div class="line">查看</div><div class="line">jinfo -flag MaxHeapSize &lt;pid&gt;（查看最大内存）</div><div class="line">-XX:+PrintFlagsInitial</div><div class="line">-XX:+PrintFlagsFinal</div><div class="line">-XX:+UnlockExperimentalVMOptions 解锁实验参数</div><div class="line">-XX:+UnlockDiagnosticVMOptions 解锁诊断参数</div><div class="line">-XX:+PrintCommandLineFlags 打印命令行参数</div><div class="line">输出结果中=表示默认值，:=表示被用户或 JVM 修改后的值</div><div class="line">示例：java -XX:+PrintFlagsFinal -version</div></pre></td></tr></table></figure>
<h4 id="2-jinfo-amp-jps-参数和进程查看"><a href="#2-jinfo-amp-jps-参数和进程查看" class="headerlink" title="2.jinfo &amp; jps(参数和进程查看)"></a>2.jinfo &amp; jps(参数和进程查看)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">pid 可通过类似 ps -ef|grep tomcat或 jps来进行查看</div><div class="line">jps</div><div class="line">[详情参考 jps官方文档](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jps.html)</div><div class="line">-l</div><div class="line">jinfo</div><div class="line">jinfo -flag MaxHeapSize &lt;pid&gt;</div><div class="line">jinfo -flags &lt;pid&gt;</div><div class="line"></div><div class="line">jstat</div><div class="line">[详情参考 jps官方文档](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html#BEHBBBDJ)</div><div class="line">jstat 使用示例</div></pre></td></tr></table></figure>
<h6 id="3-jstat-类加载、垃圾收集、JIT-编译"><a href="#3-jstat-类加载、垃圾收集、JIT-编译" class="headerlink" title="3.jstat(类加载、垃圾收集、JIT 编译)"></a>3.jstat(类加载、垃圾收集、JIT 编译)</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">类加载</div><div class="line">每隔1000ms 即1秒，共输出10次</div><div class="line">jstat -class &lt;pid&gt; 1000 10</div><div class="line">loaded 加载类的个数</div><div class="line">[root@localhost java]# jps</div><div class="line">4167 Jps</div><div class="line">3370 Bootstrap</div><div class="line">[root@localhost java]# jstat -class 3370</div><div class="line">Loaded  Bytes  Unloaded  Bytes     Time</div><div class="line">  5990 12028.7        0     0.0      15.50</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">垃圾收集</div><div class="line">[root@localhost java]# jstat -gc 3370</div><div class="line">Warning: Unresolved Symbol: sun.gc.metaspace.capacity substituted NaN</div><div class="line">Warning: Unresolved Symbol: sun.gc.metaspace.used substituted NaN</div><div class="line">Warning: Unresolved Symbol: sun.gc.compressedclassspace.capacity substituted NaN</div><div class="line">Warning: Unresolved Symbol: sun.gc.compressedclassspace.used substituted NaN</div><div class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</div><div class="line">1600.0 1600.0  0.0   1600.0 13184.0   7779.2   32696.0    22669.8     -      -      -      -       117    1.056   5      0.386    1.441</div><div class="line">-gc, -gcutil, -gccause, -gcnew, -gcold</div><div class="line">jstat -gc &lt;pid&gt; 1000 10</div><div class="line">以下大小的单位均为 KB</div><div class="line">S0C, S1C, S0U, S1U: S0和 S1的总量和使用量</div><div class="line">EC, EU: Eden区总量与使用量</div><div class="line">OC, OU: Old区总量与使用量</div><div class="line">MC, MU: Metacspace区(jdk1.8前为 PermGen)总量与使用量</div><div class="line">CCSC, CCSU: 压缩类区总量与使用量</div><div class="line">YGC, YGCT: YoungGC 的次数与时间</div><div class="line">FGC, FGCT: FullGC 的次数与时间</div><div class="line">GCT: 总的 GC 时间</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">JIT 编译</div><div class="line">-compiler, -printcompilation</div><div class="line">[root@localhost java]# jstat -compiler 3370</div><div class="line">Compiled Failed Invalid   Time   FailedType FailedMethod</div><div class="line">     833      0       0    26.04          0</div><div class="line">    花费26.04s编译了833个方法</div></pre></td></tr></table></figure>
<h4 id="4-jmap-MAT-内存溢出"><a href="#4-jmap-MAT-内存溢出" class="headerlink" title="4.jmap+MAT(内存溢出)"></a>4.jmap+MAT(内存溢出)</h4><p>内存溢出演示：<br><a href="https://start.spring.io/" target="_blank" rel="external">生成springboot初始化代码</a><br><a href="https://github.com/vipcolud/monitor" target="_blank" rel="external">最终代码</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">为快速产生内存溢出，右击 Run As&gt;Run Configurations, Arguments 标签VM arguments 中填入</div><div class="line">-Xmx32M -Xms32M</div><div class="line">访问 http://localhost:8080/heap</div><div class="line">Exception in thread &quot;http-nio-8080-ClientPoller-0&quot; java.lang.OutOfMemoryError: GC overhead limit exceeded</div><div class="line">    at java.util.HashMap$KeySet.iterator(HashMap.java:916)</div><div class="line">    at java.util.HashSet.iterator(HashSet.java:172)</div><div class="line">    at java.util.Collections$UnmodifiableCollection$1.&lt;init&gt;(Collections.java:1039)</div><div class="line">Exception in thread &quot;http-nio-8080-exec-1&quot; java.lang.OutOfMemoryError: GC overhead limit exceeded</div><div class="line">-XX:MetaspaceSize=32M -XX:MaxMetaspaceSize=32M（同时在 pom.xml 中加入 asm 的依赖）</div><div class="line">访问 http://localhost:8080/nonheap</div><div class="line">Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Metaspace</div><div class="line">Exception in thread &quot;ContainerBackgroundProcessor[StandardEngine[Tomcat]]&quot; java.lang.OutOfMemoryError: Metaspace</div><div class="line">内存溢出自动导出</div><div class="line">-XX:+HeapDumpOnOutOfMemoryError</div><div class="line">-XX:HeapDumpPath=./</div><div class="line">右击 Run As&gt;Run Configurations, Arguments 标签VM arguments 中填入</div><div class="line">-Xmx32M -Xms32M -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=./</div><div class="line">可以看到自动在当前目录中生成了一个java_pid660.hprof文件</div><div class="line">java.lang.OutOfMemoryError: GC overhead limit exceeded</div><div class="line">Dumping heap to ./java_pid660.hprof ...</div><div class="line">另一种导出溢出也更推荐的方式是jmap</div><div class="line">option: -heap, -clstats, -dump:&lt;dump-options&gt;, -F</div><div class="line">jmap -dump:format=b,file=heap.hprof &lt;pid&gt;</div><div class="line">C:\Users\Mr Chen&gt;jps -l</div><div class="line">10476 sun.tools.jps.Jps</div><div class="line">6744</div><div class="line">14980 com.imooc.monitor_tuning.MonitorTuningApplication</div><div class="line">C:\Users\Mr Chen&gt;cd desktop</div><div class="line">C:\Users\Mr Chen\Desktop&gt;jmap -dump:format=b,file=heap.hprof 14980</div><div class="line">Dumping heap to C:\Users\Mr Chen\Desktop\heap.hprof ...</div><div class="line">Heap dump file created</div></pre></td></tr></table></figure></p>
<p>jmap 导出溢出文件<br><a href="http://www.eclipse.org/mat/" target="_blank" rel="external">MAT下载地址</a><br>找开上述导出的内存溢出文件即可进行分析，如下图的溢出源头分析：<br>Memory Analyzer 内存溢出分析</p>
<h4 id="5-jstack-线程、死循环、死锁"><a href="#5-jstack-线程、死循环、死锁" class="headerlink" title="5.jstack(线程、死循环、死锁)"></a>5.jstack(线程、死循环、死锁)</h4><h5 id="1-线程状态"><a href="#1-线程状态" class="headerlink" title="1.线程状态"></a>1.线程状态</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">jstack： 打印jvm内部所有线程</div><div class="line">C:\Users\Mr Chen\Desktop&gt;jps -l</div><div class="line">15260 com.imooc.monitor_tuning.MonitorTuningApplication</div><div class="line">10836 sun.tools.jps.Jps</div><div class="line">6744</div><div class="line">C:\Users\Mr Chen\Desktop&gt;jstack 15260&gt; 15260.txt</div></pre></td></tr></table></figure>
<p>可查看其中包含java.lang.Thread.State: WAITING (parking)，JAVA 线程包含的状态有：<br>NEW：线程尚未启动<br>RUNNABLE：线程正在 JVM 中执行<br>BLOCKED：线程在等待监控锁(monitor lock)<br>WAITING：线程在等待另一个线程进行特定操作（时间不确定）<br>TIMED_WAITING：线程等待另一个线程进行限时操作<br>TERMINATED：线程已退出</p>
<h5 id="2-死循环导致cpu飙高"><a href="#2-死循环导致cpu飙高" class="headerlink" title="2.死循环导致cpu飙高"></a>2.死循环导致cpu飙高</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">monitor_tuning中新增CpuController.java</div><div class="line">直接 maven clean、 maven install</div><div class="line">此时会生成一个monitor_tuning-0.0.1-SNAPSHOT.jar的 jar包，为避免本地的 CPU 消耗过多导致死机，建议上传上传到虚拟机进行测试</div><div class="line">nohup java -jar monitor_tuning-0.0.1-SNAPSHOT.jar &amp;</div><div class="line">访问 http://xx.xx.xx.xx:8080/loop(端口8080在application.properties文件中定义)</div><div class="line">top -p &lt;pid&gt; -H可以查看线程及 CPU 消耗情况</div><div class="line">top 命令打出线程 CPU 消耗</div></pre></td></tr></table></figure>
<p>使用 jstack <pid>可以导出追踪文件，文件中 PID 在 jstack 中显示的对应 nid 为十六进制(命令行可执行 print ‘%x’ <pid>可以进行转化，如4008对应的十六进制为1007)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost java]# jstack 4008 &gt; 4008.txt</div><div class="line">[root@localhost java]# printf &quot;%x&quot; 4103</div><div class="line">1007[root@localhost java]# jstack 4103 &gt; 4103.txt</div></pre></td></tr></table></figure></pid></pid></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&quot;http-nio-8080-exec-7&quot; #22 daemon prio=5 os_prio=0 tid=0x00007f6378be7000 nid=0x1026 runnable [0x00007f63556d1000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line">    at java.lang.String.indexOf(String.java:1769)</div><div class="line">    at java.lang.String.indexOf(String.java:1718)</div><div class="line">    at com.imooc.monitor_tuning.chapter2.CpuController.getPartneridsFromJson(CpuController.java:73)</div></pre></td></tr></table></figure>
<p><strong>说明getPartneridsFromJson这里导致的cpu飙升</strong></p>
<h5 id="3-死锁"><a href="#3-死锁" class="headerlink" title="3.死锁"></a>3.死锁</h5><p>访问<a href="http://xx.xx.xx.xx:8080/deadlock(如上jstack" target="_blank" rel="external">http://xx.xx.xx.xx:8080/deadlock(如上jstack</a> <pid>导出追踪记录会发现如下这样的记录)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost java]# ps -ef |grep  java</div><div class="line">root       4357   3145 23 02:00 pts/0    00:01:22 java -jar monitor_tuning-0.0.1-SNAPSHOT.jar</div><div class="line">root       4474   3707  0 02:06 pts/3    00:00:00 grep --color=auto java</div><div class="line">[root@localhost java]# jstack 4357 &gt; 4357.txt</div></pre></td></tr></table></figure></pid></p>
<p>将文件拉到最后会发现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&quot;Thread-5&quot;:</div><div class="line">    at com.imooc.monitor_tuning.chapter2.CpuController.lambda$deadlock$1(CpuController.java:41)</div><div class="line">    - waiting to lock &lt;0x00000000f6b383e0&gt; (a java.lang.Object)</div><div class="line">    - locked &lt;0x00000000f6b383f0&gt; (a java.lang.Object)</div><div class="line">    at com.imooc.monitor_tuning.chapter2.CpuController$$Lambda$337/678439847.run(Unknown Source)</div><div class="line">    at java.lang.Thread.run(Thread.java:748)</div><div class="line">&quot;Thread-4&quot;:</div><div class="line">    at com.imooc.monitor_tuning.chapter2.CpuController.lambda$deadlock$0(CpuController.java:33)</div><div class="line">    - waiting to lock &lt;0x00000000f6b383f0&gt; (a java.lang.Object)</div><div class="line">    - locked &lt;0x00000000f6b383e0&gt; (a java.lang.Object)</div><div class="line">    at com.imooc.monitor_tuning.chapter2.CpuController$$Lambda$336/498593401.run(Unknown Source)</div><div class="line">    at java.lang.Thread.run(Thread.java:748)</div><div class="line">Found 1 deadlock.</div></pre></td></tr></table></figure></p>
<p><strong>线程4在等待线程5，同时线程5也在等待线程4，此时死锁</strong></p>
<h4 id="6-JVisualVM-本地和远程可视化监控"><a href="#6-JVisualVM-本地和远程可视化监控" class="headerlink" title="6.JVisualVM(本地和远程可视化监控)"></a>6.JVisualVM(本地和远程可视化监控)</h4><h5 id="1-监控本地java进程"><a href="#1-监控本地java进程" class="headerlink" title="1.监控本地java进程"></a>1.监控本地java进程</h5><p>详情参考官方文档<br>Mac命令行直接输入jvisualvm命令，Windows 找到对应的 exe 文件双击即可打开<br>插件安装Tools&gt;Plugins&gt;Settings根据自身版本(java -version)更新插件中心地址，各版本查询地址：<br><a href="https://visualvm.github.io/pluginscenters.html" target="_blank" rel="external">jvisualvm插件</a><br>建议安装：Visual GC, BTrace Workbench</p>
<h5 id="2-监控远程java进程"><a href="#2-监控远程java进程" class="headerlink" title="2.监控远程java进程"></a>2.监控远程java进程</h5><p>以上是本地的JAVA进程监控，还可以进行远程的监控，在上图左侧导航的 Applications 下的 Remote 处右击Add Remote Host…，输入主机 IP 即可添加，在 IP 上右击会发现有两种连接 JAVA 进程进行监控的方式:JMX, jstatd<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vi bin/catalina.sh(以192.168.73.0为例)</div><div class="line">:/JAVA_OPTS 按两个n 添加</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9004 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.net.preferIPv4Stack=true -Djava.rmi.server.hostname=192.168.73.0&quot;</div></pre></td></tr></table></figure>
<p><strong>报错</strong><br>异常情况：VisualVM 无法使用 service:jmx:rmi:///jndi/rmi:///jmxrmi 连接到<br>原因：<br>除了JMX server指定的监听端口号外，JMXserver还会监听一到两个随机端口号，<br>可以通过命grep <pid> 来查看当前java进程需要监听的随机端口号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@localhost bin]# jps</div><div class="line">4216 Jps</div><div class="line">4031 Bootstrap</div><div class="line">[root@localhost bin]# lsof -i|grep java | grep 4031</div><div class="line">java      4031    root   19u  IPv4  32304      0t0  TCP *:33707 (LISTEN)</div><div class="line">java      4031    root   20u  IPv4  32310      0t0  TCP *:9004 (LISTEN)</div><div class="line">java      4031    root   21u  IPv4  32322      0t0  TCP *:50022 (LISTEN)</div><div class="line">java      4031    root   53u  IPv4  32323      0t0  TCP *:webcache (LISTEN)</div><div class="line">java      4031    root   57u  IPv4  32325      0t0  TCP *:8009 (LISTEN)</div><div class="line">java      4031    root   69u  IPv4  32338      0t0  TCP localhost:mxi (LISTEN)</div><div class="line">将监听的端口去掉防火墙当然9004端口也是需要去掉的</div><div class="line">[root@localhost bin]# iptables -I INPUT -p tcp --dport 33707 -j ACCEPT</div><div class="line">[root@localhost bin]# iptables -I INPUT -p tcp --dport 50022 -j ACCEPT</div><div class="line">[root@localhost bin]# iptables -I INPUT -p tcp --dport 8009 -j ACCEPT</div></pre></td></tr></table></figure></pid></p>
<p>启动tomcat，以 JMX 为例，在 IP 上右击点击Add JMX Connection…，输入 192.168.73.0:9004<br>Add JMX Connection<br>以上为 Tomcat，其它 JAVA 进程也是类似的，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nohup java -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9005 -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.net.preferIPv4Stack=true -Djava.rmi.server.hostname=192.168.73.0 -jar monitor_tuning-0.0.1-SNAPSHOT.jar &amp;</div></pre></td></tr></table></figure></p>
<h4 id="6-使用-BTrace-进行拦截调试"><a href="#6-使用-BTrace-进行拦截调试" class="headerlink" title="6.使用 BTrace 进行拦截调试"></a>6.使用 BTrace 进行拦截调试</h4><p><a href="https://github.com/btraceio/btrace/releases/tag/v1.3.11.1" target="_blank" rel="external">下载BTrace </a><br>可以动态地向目标应用程序的字节码注入追踪代码，使用的技术有 JavaCompilerApi, JVMTI, Agent, Instrumentation+ASM<br>使用方法：JVisualVM中添加 BTrace 插件<br>方法二：btrace <pid> <trace_script><br>monitor_tuning中新增包org.alanhou.monitor_tuning.chapter4<br>安装BTrace 要记得配置环境变量，以 windos 为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">BTRACE_HOME  D:\Program Files\btrace-bin-1.3.11.1</div><div class="line">path 添加 %BTRACE_HOME%\bin</div><div class="line">添加btrace相关依赖btrace-agent, btrace-boot, btrace-client</div></pre></td></tr></table></figure></trace_script></pid></p>
<p>访问：<a href="http://localhost:8080/ch4/arg1?name=belong" target="_blank" rel="external">http://localhost:8080/ch4/arg1?name=belong</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">d:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;jps -l</div><div class="line">3932 com.imooc.monitor_tuning.MonitorTuningApplication</div><div class="line">1108 sun.tools.jps.Jps</div><div class="line">7852 org/netbeans/Main</div><div class="line">15456</div><div class="line"></div><div class="line">d:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;btrace 3932 PrintArgSimple.java</div><div class="line">[belong, ]</div><div class="line">com.imooc.monitor_tuning.chapter4.Ch4Controller,arg1</div></pre></td></tr></table></figure></p>
<h5 id="1-拦截方法"><a href="#1-拦截方法" class="headerlink" title="1.拦截方法"></a>1.拦截方法</h5><p>普通方法：@OnMethod( clazz=””, method=””)，如上例(PrintArgSimple.java)<br>构造函数：@OnMethod( clazz=””, method=”<init> “)<br>访问 <a href="http://localhost:8080/ch4/constructor?id=1&amp;name=belong" target="_blank" rel="external">http://localhost:8080/ch4/constructor?id=1&amp;name=belong</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">d:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;jps -l</div><div class="line">3296 sun.tools.jps.Jps</div><div class="line">7852 org/netbeans/Main</div><div class="line">15592 com.imooc.monitor_tuning.MonitorTuningApplication</div><div class="line">15456</div><div class="line"></div><div class="line">d:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;btrace 15592 PrintConstructor.java</div><div class="line">com.imooc.monitor_tuning.chapter2.User,&lt;init&gt;</div><div class="line">[1, belong, ]</div></pre></td></tr></table></figure></init></p>
<h5 id="2-拦截同名函数：用参数区分（PrintSame-java）"><a href="#2-拦截同名函数：用参数区分（PrintSame-java）" class="headerlink" title="2.拦截同名函数：用参数区分（PrintSame.java）"></a>2.拦截同名函数：用参数区分（PrintSame.java）</h5><p>如下例中虽然方法名相同，但分别有一个和两个参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">@RequestMapping(&quot;/same1&quot;)</div><div class="line">public String same(@RequestParam(&quot;name&quot;)String name) &#123;</div><div class="line">    // 访问地址:  http://localhost:8080/ch4/same1?name=Java</div><div class="line">    return &quot;Hello, &quot;+name;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@RequestMapping(&quot;/same2&quot;)</div><div class="line">public String same(@RequestParam(&quot;name&quot;)String name, @RequestParam(&quot;id&quot;)int id) &#123;</div><div class="line">    // 访问地址:  http://localhost:8080/ch4/same2?name=Java&amp;id=1</div><div class="line">    return &quot;Hello, &quot;+name+&quot;, &quot;+id;</div><div class="line">&#125;</div><div class="line"></div><div class="line">import com.sun.btrace.BTraceUtils;</div><div class="line">import com.sun.btrace.annotations.BTrace;</div><div class="line">import com.sun.btrace.annotations.OnMethod;</div><div class="line">import com.sun.btrace.annotations.ProbeClassName;</div><div class="line">import com.sun.btrace.annotations.ProbeMethodName;</div><div class="line"></div><div class="line">@BTrace</div><div class="line">public class PrintSame &#123;</div><div class="line"></div><div class="line">    @OnMethod(</div><div class="line">            clazz=&quot;com.imooc.monitor_tuning.chapter4.Ch4Controller&quot;,</div><div class="line">            method=&quot;same&quot;</div><div class="line">    )</div><div class="line">    public static void anyRead(@ProbeClassName String pcn, @ProbeMethodName String pmn, String  name,int id) &#123;</div><div class="line">        BTraceUtils.println(pcn+&quot;,&quot;+pmn + &quot;,&quot; + name+ &quot;,&quot; + id);</div><div class="line">        BTraceUtils.println();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="3-拦截时机"><a href="#3-拦截时机" class="headerlink" title="3.拦截时机"></a>3.拦截时机</h5><p>Kind.ENTRY: 入口，默认值（上述例子均为这种情况）<br>Kind.RETURN: 返回（PrintReturn.java）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">d:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;btrace 16268 PrintReturn.java</div><div class="line">com.imooc.monitor_tuning.chapter4.Ch4Controller,arg1,hello,belong</div></pre></td></tr></table></figure></p>
<p>Kind.THROW: 异常（PrintOnThrow.java）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">d:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;jps -l</div><div class="line">12836 sun.tools.jps.Jps</div><div class="line">16268 com.imooc.monitor_tuning.MonitorTuningApplication</div><div class="line">7852 org/netbeans/Main</div><div class="line">15456</div><div class="line"></div><div class="line">d:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;btrace 16268 PrintOnThrow.java</div><div class="line">java.lang.ArithmeticException: / by zero</div><div class="line">        com.imooc.monitor_tuning.chapter4.Ch4Controller.exception(Ch4Controller.java:41)</div><div class="line">        sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">        sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</div><div class="line">        sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</div><div class="line">        java.lang.reflect.Method.invoke(Method.java:498)</div><div class="line">        org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:209)</div><div class="line">        org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:136)</div><div class="line">        org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:102)</div></pre></td></tr></table></figure></p>
<p>打印指定行号是否执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">d:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;btrace 16268 PrintLine.java</div><div class="line">com.imooc.monitor_tuning.chapter4.Ch4Controller,exception,41</div></pre></td></tr></table></figure></p>
<h5 id="3-拦截-this、入参、返回值"><a href="#3-拦截-this、入参、返回值" class="headerlink" title="3.拦截 this、入参、返回值"></a>3.拦截 this、入参、返回值</h5><p>this：@self<br>入参：可以用 AnyType，也可以用真实类型，同名的用真实的<br>返回：@Return<br>获取对象的值<br>简单类型：直接获取<br>复杂类型：反射，类名+属性名（PrintArgComplex.java）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">D:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;jps -l</div><div class="line">2896 sun.tools.jps.Jps</div><div class="line">10568 com.imooc.monitor_tuning.MonitorTuningApplication</div><div class="line">7004</div><div class="line"></div><div class="line">D:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;btrace -cp &quot;D:\workspace\work-app\project\o435au\target\classes&quot; 10568 PrintArgComplex.java</div><div class="line">&#123;id=1, name=belong, &#125;</div><div class="line">belong</div><div class="line">com.imooc.monitor_tuning.chapter4.Ch4Controller,arg2</div></pre></td></tr></table></figure></p>
<h6 id="1-拦截函数中还可以使用正则表达式，如method-”-“匹配指定类下的所有方法-PrintRegex-java"><a href="#1-拦截函数中还可以使用正则表达式，如method-”-“匹配指定类下的所有方法-PrintRegex-java" class="headerlink" title="1.拦截函数中还可以使用正则表达式，如method=”/.*/“匹配指定类下的所有方法(PrintRegex.java)"></a>1.拦截函数中还可以使用正则表达式，如method=”/.*/“匹配指定类下的所有方法(PrintRegex.java)</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">import com.sun.btrace.BTraceUtils;</div><div class="line">import com.sun.btrace.annotations.BTrace;</div><div class="line">import com.sun.btrace.annotations.OnMethod;</div><div class="line">import com.sun.btrace.annotations.ProbeClassName;</div><div class="line">import com.sun.btrace.annotations.ProbeMethodName;</div><div class="line"></div><div class="line">@BTrace</div><div class="line">public class PrintRegex &#123;</div><div class="line"></div><div class="line">    @OnMethod(</div><div class="line">            clazz=&quot;com.imooc.monitor_tuning.chapter4.Ch4Controller&quot;,</div><div class="line">            method=&quot;/.*/&quot;   )</div><div class="line">    public static void anyRead(@ProbeClassName String pcn, @ProbeMethodName String pmn) &#123;</div><div class="line">        BTraceUtils.println(pcn+&quot;,&quot;+pmn);</div><div class="line">        BTraceUtils.println();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">D:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;btrace 10568 PrintRegex.java</div><div class="line">com.imooc.monitor_tuning.chapter4.Ch4Controller,arg2</div></pre></td></tr></table></figure>
<h6 id="2-打印环境变量-PrintJinfo-java-和-jinfo-help一样"><a href="#2-打印环境变量-PrintJinfo-java-和-jinfo-help一样" class="headerlink" title="2.打印环境变量(PrintJinfo.java)和 jinfo -help一样"></a>2.打印环境变量(PrintJinfo.java)和 jinfo -help一样</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">D:\workspace\work-app\project\o435au\src\main\java\com\imooc\monitor_tuning\chapter4&gt;btrace 10568 PrintJinfo.java</div><div class="line">System Properties:</div><div class="line">java.vm.version = 25.131-b11</div><div class="line">sun.jnu.encoding = GBK</div><div class="line">java.vendor.url = http://java.oracle.com/</div><div class="line">java.vm.info = mixed mode</div><div class="line">java.awt.headless = true</div><div class="line">user.dir = D:\workspace\work-app\project\o435au</div><div class="line">sun.cpu.isalist = amd64</div><div class="line">java.awt.graphicsenv = sun.awt.Win32GraphicsEnvironment</div><div class="line">sun.os.patch.level =</div><div class="line">catalina.useNaming = false</div><div class="line">user.home = C:\Users\Mr Chen</div><div class="line">java.io.tmpdir = C:\Users\MRCHEN~1\AppData\Local\Temp\</div><div class="line">java.awt.printerjob = sun.awt.windows.WPrinterJob</div><div class="line">java.version = 1.8.0_131</div><div class="line">file.encoding.pkg = sun.io</div><div class="line">java.vendor.url.bug = http://bugreport.sun.com/bugreport/</div><div class="line">file.encoding = UTF-8</div></pre></td></tr></table></figure>
<p>注意事项<br>默认只能本地运行<br>生产环境下可以使用，但是被修改的字节码不会被还原</p>
<h4 id="7-Tomcat-性能监控与调优"><a href="#7-Tomcat-性能监控与调优" class="headerlink" title="7.Tomcat 性能监控与调优"></a>7.Tomcat 性能监控与调优</h4><h5 id="1-Tomcat-远程-Debug"><a href="#1-Tomcat-远程-Debug" class="headerlink" title="1.Tomcat 远程 Debug"></a>1.Tomcat 远程 Debug</h5><p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jpda3/" target="_blank" rel="external">JDWP</a><br>bin/startup.sh 修改最后一行(添加 jpda)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">exec &quot;$PRGDIR&quot;/&quot;$EXECUTABLE&quot; jpda start &quot;$@&quot;</div></pre></td></tr></table></figure></p>
<p>bin/catalina.sh 为便于远程调试进行如下修改<br>JPDA_ADDRESS=”localhost:8000”<br> 修改为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if [ -z &quot;$JPDA_ADDRESS&quot; ]; then</div><div class="line">  JPDA_ADDRESS=&quot;54321&quot;</div><div class="line">fi</div><div class="line">if [ -z &quot;$JPDA_SUSPEND&quot; ]; then</div><div class="line">  JPDA_SUSPEND=&quot;n&quot;</div></pre></td></tr></table></figure></p>
<p>查看日志发现已经启动起来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail -f ./logs/catalina.out</div></pre></td></tr></table></figure></p>
<p>再查看54321端口是否被监听<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost apache-tomcat-8.5.34]# netstat -nap | grep 54321</div><div class="line">tcp        0      0 0.0.0.0:54321           0.0.0.0:*               LISTEN      3314/java</div></pre></td></tr></table></figure></p>
<p>打开54321端口防火墙<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost apache-tomcat-8.5.34]#  iptables -I INPUT -p tcp --dport 54321 -j ACCEPT</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">若发现54321端口启动存在问题可尝试bin/catalina.sh jpda start</div><div class="line">本地添加包org.alanhou.monitor_tuning.chapter5，修改打包方式为 war，并重写configure，进入monitor_tuning文件夹，执行mvn clean package 进行打包，target 目录下默认生成的包名为monitor_tuning-0.0.1-SNAPSHOT.war，为便于访问修改为monitor_tuning.war再上传到服务器的webapps目录下</div><div class="line">http://192.168.0.5:8080/monitor_tuning/ch5/hello</div><div class="line">使用 Eclipse 远程调试，右击 Debug As &gt; Debug Configurations... &gt; Remote Java Application &gt; 右击 New 新建</div></pre></td></tr></table></figure>
<h5 id="2-tomcat-manager-监控"><a href="#2-tomcat-manager-监控" class="headerlink" title="2.tomcat-manager 监控"></a>2.tomcat-manager 监控</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">1.conf/tomcat-users.xml添加用户</div><div class="line">  &lt;role rolename=&quot;tomcat&quot;/&gt;</div><div class="line">  &lt;role rolename=&quot;manager-status&quot;/&gt;</div><div class="line">  &lt;role rolename=&quot;manager-gui&quot;/&gt;</div><div class="line">  &lt;user username=&quot;tomcat&quot; password=&quot;123456&quot; roles=&quot;tomcat,manager-gui,manager-status&quot;/&gt;</div><div class="line">2.新建conf/Catalina/localhost/manager.xml配置允许的远程连接</div><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;Context privileged=&quot;true&quot; antiResourceLocking=&quot;false&quot;</div><div class="line">        docBase=&quot;$(catalina.home)/webapps/manager&quot;&gt;</div><div class="line">  &lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</div><div class="line">        allow=&quot;127.0.0.1&quot; /&gt;</div><div class="line">&lt;/Context&gt;</div><div class="line">远程连接将allow=&quot;127.0.0.1&quot;修改为allow=&quot;^.*$&quot;，浏览器中输入http://127.0.0.1:8080/manage或对应的 IP，用户名密码为tomcat-users.xml中所设置的</div><div class="line">3.重启 Tomcat 服务</div></pre></td></tr></table></figure>
<h5 id="3-psi-probe-监控"><a href="#3-psi-probe-监控" class="headerlink" title="3.psi-probe 监控"></a>3.psi-probe 监控</h5><p><a href="https://github.com/psi-probe/psi-probe" target="_blank" rel="external">psi-probe下载地址</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">下载后进入psi-probe-master目录，执行：</div><div class="line">mvn clean package -Dmaven.test.skip</div><div class="line">将 web/target/probe.war放到 Tomcat 的 webapps 目录下，同样需要conf/tomcat-users.xml和conf/Catalina/localhost/manager.xml中的配置（可保持不变），启动 Tomcat 服务</div><div class="line">浏览器中输入http://127.0.0.1:8080/probe或对应的 IP，用户名密码为tomcat-users.xml中所设置的</div></pre></td></tr></table></figure></p>
<h5 id="4-Tomcat-调优"><a href="#4-Tomcat-调优" class="headerlink" title="4.Tomcat 调优"></a>4.Tomcat 调优</h5><h6 id="1-线程优化（webapps-docs-config-http-html）："><a href="#1-线程优化（webapps-docs-config-http-html）：" class="headerlink" title="1.线程优化（webapps/docs/config/http.html）："></a>1.线程优化（webapps/docs/config/http.html）：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">maxConnections： 最大链接数现在nio 1w，之前apr8192</div><div class="line">acceptCount   ：最大排队数，超过最大连接数后的队列 默认100</div><div class="line">maxThreads  ： 工作线程，最大并发</div><div class="line">minSpareThreads ：最小空闲线程，不能设置太小</div></pre></td></tr></table></figure>
<h6 id="2-配置优化（webapps-docs-config-host-html）："><a href="#2-配置优化（webapps-docs-config-host-html）：" class="headerlink" title="2.配置优化（webapps/docs/config/host.html）："></a>2.配置优化（webapps/docs/config/host.html）：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">autoDeploy： 周期性检查是否有新应用部署，默认true，生产千万不能true</div><div class="line">enableLookups（http.html）：默认false，千万不能true</div><div class="line">reloadable（context.html）：默认false，千万不要true</div><div class="line">protocol=&quot;org.apache.coyote.http11.Http11AprProtocol&quot;   8.5以后nio</div><div class="line">apr用于大并发  比较合适</div><div class="line">Session 优化：</div><div class="line">如果是 JSP, 可以禁用原生 Session=false</div><div class="line">session放在redis</div></pre></td></tr></table></figure>
<h6 id="3-补充：APR-配置"><a href="#3-补充：APR-配置" class="headerlink" title="3.补充：APR 配置"></a>3.补充：APR 配置</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">yum install -y apr-devel openssl-devel</div><div class="line">cd tomcat/bin</div><div class="line">tar -zxvf tomcat-native.tar.gz</div><div class="line">cd tomcat-native-1.2.17-src/native/</div><div class="line">./configure --with-apr=/usr/bin/apr-1-config --with-java-home=/usr/lib/jvm/java-1.8.0 --with-ssl=yes</div><div class="line">make &amp;&amp; make install</div><div class="line"></div><div class="line">vi tomcat/bin/setenv.sh</div><div class="line">export CATALINA_OPTS=”$CATALINA_OPTS -Djava.library.path=/usr/local/apr/lib”</div><div class="line">#vi tomcat/conf/server.xml</div><div class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</div><div class="line">               connectionTimeout=&quot;20000&quot;</div><div class="line">               redirectPort=&quot;8443&quot; /&gt;</div><div class="line"> 修改为</div><div class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;org.apache.coyote.http11.Http11AprProtocol&quot;</div><div class="line">               connectionTimeout=&quot;20000&quot;</div><div class="line">               redirectPort=&quot;8443&quot; /&gt;</div><div class="line"></div><div class="line"></div><div class="line">&lt;Listener className=&quot;org.apache.catalina.core.AprLifecycleListener&quot; SSLEngine=&quot;on&quot; /&gt;</div></pre></td></tr></table></figure>
<h5 id="5-Nginx-性能监控与调优"><a href="#5-Nginx-性能监控与调优" class="headerlink" title="5.Nginx 性能监控与调优"></a>5.Nginx 性能监控与调优</h5><h6 id="1-Nginx-安装"><a href="#1-Nginx-安装" class="headerlink" title="1.Nginx 安装"></a>1.Nginx 安装</h6><p>添加 yum 源（/etc/yum.repos.d/nginx.repo）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost Desktop]# vi /etc/yum.repos.d/nginx.repo</div><div class="line">[nginx]</div><div class="line">name=nginx repo</div><div class="line">baseurl=http://nginx.org/packages/centos/7/x86_64/     #7为当前centos的版本号</div><div class="line">gpgcheck=0</div><div class="line">enabled=1</div><div class="line">[root@localhost Desktop]# yum install -y nginx</div></pre></td></tr></table></figure></p>
<p>关闭80端口防火墙，打开nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx]# iptables -I INPUT -p tcp --dport 80 -j ACCEPT</div><div class="line">[root@localhost nginx]# nginx</div><div class="line">[root@localhost nginx]# ps -ef | grep nginx</div><div class="line">root      12178      1  0 01:25 ?        00:00:00 nginx: master process nginx</div><div class="line">nginx     12180  12178  0 01:25 ?        00:00:00 nginx: worker process</div><div class="line">root      12192  11673  0 01:25 pts/0    00:00:00 grep --color=auto nginx</div></pre></td></tr></table></figure></p>
<p>开启<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx]# nginx</div></pre></td></tr></table></figure></p>
<p>重启<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx]# nginx -s reload</div></pre></td></tr></table></figure></p>
<p>停止<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx]# nginx -s stop</div></pre></td></tr></table></figure></p>
<p>查看编译参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx -v</div></pre></td></tr></table></figure></p>
<p>默认配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/etc/nginx/nginx.conf</div><div class="line">注意：配置反向代理要关闭selinux，setenforce 0</div></pre></td></tr></table></figure></p>
<p>取消注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat default.conf | grep -v &quot;#&apos;</div></pre></td></tr></table></figure></p>
<h6 id="2-ngx-http-stub-status-监控连接信息"><a href="#2-ngx-http-stub-status-监控连接信息" class="headerlink" title="2.ngx_http_stub_status 监控连接信息"></a>2.ngx_http_stub_status 监控连接信息</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[root@localhost Desktop]# cd /etc/nginx</div><div class="line">[root@localhost nginx]# cd conf.d/</div><div class="line">[root@localhost conf.d]# ll</div><div class="line">total 4</div><div class="line">-rw-r--r--. 1 root root 1093 Nov  6 05:54 default.conf</div><div class="line">[root@localhost conf.d]# vi default.conf</div><div class="line">添加</div><div class="line">location = /nginx_status &#123;</div><div class="line">    stub_status on;</div><div class="line">    access_log off;</div><div class="line">    allow 127.0.0.1;</div><div class="line">    deny all;</div><div class="line">&#125;</div><div class="line">重启</div><div class="line">[root@localhost conf.d]# nginx -s reload</div><div class="line">查看连接信息</div><div class="line">[root@localhost conf.d]# wget http://127.0.0.1/nginx_status</div><div class="line">--2018-11-12 19:46:04--  http://127.0.0.1/nginx_status</div><div class="line">Connecting to 127.0.0.1:80... connected.</div><div class="line">HTTP request sent, awaiting response... 200 OK</div><div class="line">Length: 97 [text/plain]</div><div class="line">Saving to: ‘nginx_status’</div><div class="line"></div><div class="line">100%[======================================&gt;] 97          --.-K/s   in 0s</div><div class="line"></div><div class="line">2018-11-12 19:46:04 (5.45 MB/s) - ‘nginx_status’ saved [97/97]</div><div class="line"></div><div class="line">[root@localhost conf.d]# cat nginx_status</div><div class="line">Active connections: 1     当前活动连接数 包含正在等待的连接  并发数</div><div class="line">server accepts handled requests</div><div class="line"> 7 7 7</div><div class="line">Reading: 0当前正在发生请求  Writing: 1 nginx相应写回客户端的连接数</div><div class="line">Waiting: 0    当前空闲的连接数</div></pre></td></tr></table></figure>
<h6 id="2-ngxtop"><a href="#2-ngxtop" class="headerlink" title="2.ngxtop"></a>2.ngxtop</h6><p><a href="https://github.com/lebinh/ngxtop" target="_blank" rel="external">ngxtop</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">安装 python-pip</div><div class="line">yum install epel-release</div><div class="line">yum install python-pip</div><div class="line"> 安装 ngxtop</div><div class="line">pip install ngxtop</div><div class="line">指定配置文件，查询具体访问：ngxtop -c /etc/nginx/nginx.conf</div><div class="line">查询状态是200：ngxtop -c /etc/nginx/nginx.conf -i &apos;status == 200&apos;</div><div class="line">查询访问最多 ip：ngxtop -c /etc/nginx/nginx.conf -g remote_addr</div><div class="line">ngxtop查询访问最多 ip</div></pre></td></tr></table></figure></p>
<h6 id="3-nginx-rrd-图形化监控"><a href="#3-nginx-rrd-图形化监控" class="headerlink" title="3.nginx-rrd 图形化监控"></a>3.nginx-rrd 图形化监控</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">nginx-rrd 依赖于前面的ngx_http_stub_status</div><div class="line">安装 php</div><div class="line">yum install php php-gd php-soap php-mbstring php-xmlrpc php-dom php-fpm -y</div><div class="line">Ngnix融合 php-fpm(/etc/php-fpm.d/www.conf)</div><div class="line"></div><div class="line">修改</div><div class="line">[root@localhost nginx]# vi /etc/php-fpm.d/www.conf</div><div class="line">user = nginx</div><div class="line">; RPM: Keep a group allowed to write in log dir.</div><div class="line">group = nginx</div><div class="line">启动 php-fpm</div><div class="line">[root@localhost nginx]# systemctl start php-fpm</div><div class="line">[root@localhost nginx]# netstat -nat | grep 9000</div><div class="line">tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN</div><div class="line"> 修改 Nginx 配置文件</div><div class="line">  [root@localhost nginx]# vi /etc/nginx/conf.d/default.conf</div><div class="line">  加入</div><div class="line">location ~ .php$ &#123;</div><div class="line">    root           /usr/share/nginx/html;</div><div class="line">    fastcgi_pass   127.0.0.1:9000;</div><div class="line">    fastcgi_index  index.php;</div><div class="line">    fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name;</div><div class="line">    include        fastcgi_params;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>新建php文件查看php是否安装成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx]# cd /usr/share/nginx/html</div><div class="line">[root@localhost html]# vi index.php</div><div class="line">&lt;?php phpinfo(); ?&gt;</div><div class="line">关闭防火墙</div><div class="line">systemctl stop firewalld</div><div class="line">访问 http://192.168.81.128/index.php 检测配置是否成功</div></pre></td></tr></table></figure></p>
<p>安装 rddtool 相关依赖<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost html]# yum install perl rrdtool perl-libwww-perl libwww-perl perl-rrdtool -y</div><div class="line">移动文件到当前文件</div><div class="line">[root@localhost tmp]# mv /usr/share/nginx/html/nginx-rrd-0.1.4.tgz .</div></pre></td></tr></table></figure></p>
<p> 安装 nginx-rdd<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">wget http://soft.vpser.net/status/nginx-rrd/nginx-rrd-0.1.4.tgz</div><div class="line">tar zxvf nginx-rrd-0.1.4.tgz</div><div class="line">cd nginx-rrd-0.1.4</div><div class="line">cp usr/sbin/* /usr/sbin     # 复制主程序文件到 /usr/sbin 下</div><div class="line">cp etc/nginx-rrd.conf /etc  # 复制配置文件到 /etc 下</div><div class="line">cp html/index.php /usr/share/nginx/html/</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> 修改配置(vi /etc/nginx-rrd.conf)</div><div class="line">RRD_DIR=&quot;/usr/share/nginx/html/nginx-rrd&quot;;</div><div class="line">WWW_DIR=&quot;/usr/share/nginx/html&quot;;</div><div class="line">添加定时任务</div><div class="line">[root@localhost nginx-rrd-0.1.4]# crontab -e</div><div class="line">*  * * * * /bin/sh /usr/sbin/nginx-collect</div><div class="line">*/1 * * * * /bin/sh /usr/sbin/nginx-graph</div><div class="line"> 查看定时任务执行情况</div><div class="line">tail -f /var/log/cron</div><div class="line">ab 压测（未安装 yum -y install httpd-tools）</div><div class="line">ab -n 10000 -c 10 http://127.0.0.1/index.html</div><div class="line">访问 http://192.168.81.128/index.php 即可得到如下这种图形化界面：</div></pre></td></tr></table></figure>
<h5 id="4-Nginx-优化"><a href="#4-Nginx-优化" class="headerlink" title="4.Nginx 优化"></a>4.Nginx 优化</h5><h6 id="4-配置线程数和并发数"><a href="#4-配置线程数和并发数" class="headerlink" title="4.配置线程数和并发数"></a>4.配置线程数和并发数</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">增加工作线程数和并发连接数</div><div class="line">[root@localhost /]# vi /etc/nginx/nginx.conf</div><div class="line">worker_processes  4; # 一般CPU 是几核就设置为几 也可以设置成auto</div><div class="line">events &#123;</div><div class="line">    worker_connections  10240; # 每个进程打开的最大连接数，包含了 Nginx 与客户端和 Nginx 与 upstream 之间的连接</div><div class="line">    multi_accept on; # 可以一次建立多个连接</div><div class="line">    use epoll;   #epoll这种网络模型</div><div class="line">&#125;</div><div class="line">查看nginx 语法是否正确</div><div class="line">[root@localhost /]# nginx -t</div><div class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class="line">启用长连接</div><div class="line">[root@localhost /]# vi /etc/nginx/nginx.conf</div><div class="line">配置反向代理</div><div class="line">upstream server_pool&#123;</div><div class="line">    server localhost:8080 weight=1 max_fails=2 fail_timeout=30s;</div><div class="line">    server localhost:8081 weight=1 max_fails=2 fail_timeout=30s;</div><div class="line">    keepalive 300; # 300个长连接 提高效率</div><div class="line">&#125;</div><div class="line">配置反向代理服务</div><div class="line">location / &#123;</div><div class="line">    proxy_http_version 1.1;</div><div class="line">    proxy_set_header Upgrade $http_upgrade;</div><div class="line">    proxy_set_header Connection &quot;upgrade&quot;;</div><div class="line">    proxy_pass http://server_pool;  #所有请求都代理给server_pool</div><div class="line">&#125;</div><div class="line">配置压缩</div><div class="line">gzip on;</div><div class="line">gzip_http_version 1.1;</div><div class="line">gzip_disable &quot;MSIE [1-6].(?!.*SV1)&quot;;</div><div class="line">gzip_proxied any;</div><div class="line">gzip_types text/plain text/css application/javascript application/x-javascript application/json application/xml application/vnd.ms-fontobject application/x-font-ttf application/svg+xml application/x-icon;</div><div class="line">gzip_vary on;</div><div class="line">gzip_static on;</div><div class="line">操作系统优化</div><div class="line"> 配置文件/etc/sysctl.conf</div><div class="line">sysctl -w net.ipv4.tcp_syncookies=1 # 防止一个套接字在有过多试图连接到时引起过载</div><div class="line">sysctl -w net.core.somaxconn=1024 # 默认128，操作系统连接队列</div><div class="line">sysctl -w net.ipv4.tcp_fin_timeout=10 # timewait 的超时时间</div><div class="line">sysctl -w net.ipv4.tcp_tw_reuse=1 # os 直接使用 timewait的连接</div><div class="line">sysctl -w net.ipv4.tcp_tw_recycle=0 # 回收禁用</div><div class="line"> /etc/security/limits.conf</div><div class="line">           hard    nofile            204800</div><div class="line">            soft    nofile             204800</div><div class="line">            soft    core             unlimited</div><div class="line">             soft    stack             204800</div><div class="line">其它优化</div><div class="line">sendfile    on; # 减少文件在应用和内核之间拷贝</div><div class="line">tcp_nopush  on; # 当数据包达到一定大小再发送</div><div class="line">tcp_nodelay off; # 有数据随时发送</div></pre></td></tr></table></figure>
<h5 id="6-JVM层GC调优"><a href="#6-JVM层GC调优" class="headerlink" title="6.JVM层GC调优"></a>6.JVM层GC调优</h5><p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html" target="_blank" rel="external">jvm虚拟机规范</a></p>
<h6 id="1-运行时数据区："><a href="#1-运行时数据区：" class="headerlink" title="1.运行时数据区："></a>1.运行时数据区：</h6><p>程序计数器 PC Register<br>虚拟机栈 JVM Stacks<br>堆 Heap（java虚拟机所管理内存中最大的一块，存放对象实例）<br>方法区 Method Area（线程共享的内存区域，存储类信息，常量，静态常量，编译器编译后的代码）<br> 常量池 Run-Time Constant Pool<br>本地方法栈 Native Method Stacks</p>
<h6 id="2-常用参数："><a href="#2-常用参数：" class="headerlink" title="2.常用参数："></a>2.常用参数：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">-Xms 最小堆内存 -Xmx最大堆内存</div><div class="line">-XX:NewSize 新生代大小 -XX:MaxNewSize最大新生代大小</div><div class="line">-XX:NewRatio new和old的比例 -XX:SurvivorRatio survivor和edn的比例</div><div class="line">-XX:MetaspaceSize -XX:MaxMetaspaceSize   一般调大</div><div class="line">-XX:+UseCompressedClassPointers 是否启用压缩类指针</div><div class="line">-XX:CompressedClassSpaceSize</div><div class="line">-XX:InitialCodeCacheSize</div><div class="line">-XX:ReservedCodeCacheSize</div></pre></td></tr></table></figure>
<h6 id="3-垃圾回收算法"><a href="#3-垃圾回收算法" class="headerlink" title="3.垃圾回收算法"></a>3.垃圾回收算法</h6><p>java自动垃圾回收<br>思想：枚举根节点，做可达性分析<br>根节点：类加载器、Thread、虚拟机栈的本地变量表、static 成员、常量引用、本地方法栈的变量<br>算法：标记清除、复制、标记整理、分带垃圾回收<br>jvm垃圾回收yong区用复制算法old区用标记清除或者标记整理<br>对象分配：对象优先在 Eden 区分配、大对象直接进入Old 区(-XX:PretenureSizeThreshold)、长期存活对象进入 Old 区(-XX:MaxTenuringThreshold, -XX:+PrintTenuringDistribution, -XX:TargetSurvivorRatio</p>
<h6 id="4-垃圾收集器"><a href="#4-垃圾收集器" class="headerlink" title="4.垃圾收集器"></a>4.垃圾收集器</h6><p> 常见配置示例(bin/catalina.sh)<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">PARALLEL_OPTION=&quot;-XX:+UseParallelGC -XX:+UseParallelOldGC -XX:MaxGCPauseMillis=200 -XX:GCTimeRatio=99&quot;</div><div class="line">CMS_OPTION=&quot;-XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=5&quot;</div><div class="line">G1_OPTION=&quot;-XX:+UseG1GC -XX:+UseStringDeduplication -XX:StringDeduplicationAgeThreshold=3 -XX:+UseCompressedClassPointers -XX:MaxGCPauseMillis=200&quot;</div><div class="line"></div><div class="line">JAVA_OPTS=&quot;$JAVA_OPTS $CMS_OPTION -Xms128M -Xmx128M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M -XX:+UseCompressedClassPointers&quot;</div><div class="line">串行收集器 Serial:：Serial, Serial Old (-XX:+UseSerialGC -XX:+UseSerialOldGC)</div><div class="line">并行收集器 Parallel（吞吐量优先, Server 模式默认收集器）：Parallel Scavenge, Parallel Old (-XX:+UseParallelGC, -XX:+UseParallelOldGC)</div><div class="line"></div><div class="line">-XX:ParallelGCThreads=&lt;N&gt; 多少个 GC 线程（CPU&gt; 8 N=5/8; CPU&lt;8 N=CPU）</div><div class="line">Parallel Collector Ergonomics:</div><div class="line">-XX:MaxGCPauseMillis=&lt;N&gt;</div><div class="line">-XX:GCTimeRatio=&lt;N&gt;</div><div class="line">-Xmx&lt;N&gt;</div><div class="line">动态内存调整</div><div class="line">-XX:YoungGenerationSizeIncrement=&lt;Y&gt;</div><div class="line">-XX:TenuredGenerationSizeIncrement=&lt;T&gt;</div><div class="line">-XX:AdaptiveSizeDecrementScaleFactor=&lt;D&gt;</div><div class="line"></div><div class="line">并发收集器 Concurent（停顿时间优先）：CMS (-XX:+UseConcMarkSweepGC -XX:+UseParNewGC), G1(-XX:UseG1GC)</div><div class="line">停顿时间：垃圾收集器做垃圾回收中断应用执行的时间。</div><div class="line">-xx:MANGCPauseMillis</div><div class="line">吞吐量：花在垃圾收集的时间和花在应用时间的占比。-xx:GCTimeRatui=&lt;n&gt;,垃圾收集时间占：1/1+n 吞吐量最大的时候停顿时间最小最好</div></pre></td></tr></table></figure></p>
<p>CMS<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">并发收集，低停顿，低延迟，老年代收集器</div><div class="line">1. CMS initial mark: 初始标记 Root, STW</div><div class="line">2. CMS concurrent mark：并发标记</div><div class="line">3. CMS-concurrent-preclean：并发预清理</div><div class="line">4. CMS remark：重新标记，STW</div><div class="line">5. CMS concurrent sweep：并发清除</div><div class="line">6. CMS-concurrent-reset：并发重置</div><div class="line">缺点：CPU 敏感、产生浮动垃圾和空间碎片</div><div class="line">相关参数：</div><div class="line">-XX:ConcGCThreads：并发的 GC 线程数</div><div class="line">-XX:+UseCMSCompactAtFullCollection：FullGC 之后做压缩</div><div class="line">-XX:CMSFullGCsBeforeCompaction：多少次 FullGC之后压缩一次</div><div class="line">-XX:CMSInitiatingOccupancyFraction：触发 FullGC</div><div class="line">-XX:+UseCMSInitiatingOccupancyOnly：是否动态可调</div><div class="line">-XX:+CMSScavengeBeforeRemark：FullGC之前先做 YGC</div><div class="line">-XX:+CMSClassUnloadingEnable：启用回收Perm 区</div></pre></td></tr></table></figure></p>
<p>iCMS<br>适用于单核或者双核<br>G1 Collector(JDK 7开始，推荐使用）新生代和老生代收集器<br>G1的几个概念<br>Region<br>SATB：Snapshot-At-The-Beginning，它是通过 Root Tracing 得到的，GC 开始时候存活对象的快照。<br>RSet：记录了其他 Region中的对象引用本 Region 中对象的关系，属于 points-into 结构(谁引用了我的对象)<br>YoungGC<br>新对象进入 Eden 区<br>存活对象拷贝到Survivor 区<br>存活时间达到年龄阈值时，对象晋升到 Old 区<br>MixedGC<br>不是 FullGC，回收所有的 Young和所有的 Old<br>global concurrent marking</p>
<ol>
<li>Initial marking phase: 标记 GC Root, STW</li>
<li>Root region scanning phase：标记存活 Region</li>
<li>Concurrent marking phase：标记存活的对象</li>
<li>Remark phase：重新标记，STW</li>
<li>Cleanup phase：部分 STW</li>
</ol>
<p>MixedGC时机<br>InitiatingHeapOccupancyPercent<br>G1HeapWastePercent<br>G1MixedGCLiveThresholdPercent   Old区的region被回收时候存活对象占比<br>G1MixedGCCountTarget  一次global concurrent marking 之后最多执行mixed gc 的次数<br>G1OldGCSetRegionThresholdPercent    一次mixed GC中能被选入cset的最多old区的region数量<br>-XX:+UseG1GC 开启 G1<br>-XX:G1HeapRegionSize=n， Region 的大小，1-32M，最多2048个<br>-XX:MaxGCPauseMillis=200 最大停顿时间<br>-XX:G1NewSizePercent、-XX:G1MaxNewSizePercent<br>-XX:G1ReservePercent=10 保留防止 to space溢出<br>-XX:ParallelGCThreads=n SWT线程数并行<br>-XX:ConcGCThreads=n 并发线程数=1/4*并行</p>
<p>最佳实践<br>年轻代大小：避免使用-Xmn, -XX:NewRatio 等显式 Young 区大小，会覆盖暂停时间目标<br>暂停时间目标：暂停时间不要太严苛，其吞吐量目标是90%的应用程序时间和10%的垃圾回收时间，太严苛会直接影响到吞吐量</p>
<p>需要切换到 G1的情况：</p>
<ol>
<li>50%以上的堆被存活对象占用</li>
<li>对象分配和晋升的速度变化非常大</li>
<li>垃圾回收时间特别长，超过了1秒</li>
</ol>
<p>查看方法：jinfo -flag xxx <pid></pid></p>
<p>并行：多条垃圾收集线程并行工作，但用户线程处于等待状态<br>并发：用户线程与垃圾收集线程同时执行（或交替执行）</p>
<p>如何选择垃圾收集器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">优先调整堆的大小让服务器自己来选择</div><div class="line">如果内存小于100m，使用串行收集器</div><div class="line">如果是单核，并且没有停顿时间的要求，串行或者jvm自己选</div><div class="line">如果允许停顿时间超过1s，选择并行或者jvm自己选</div><div class="line">如果响应时间最重要，并且不能超过1s，使用并发收集器</div></pre></td></tr></table></figure></p>
<h6 id="5-可视化-GC-日志分析工具"><a href="#5-可视化-GC-日志分析工具" class="headerlink" title="5.可视化 GC 日志分析工具"></a>5.可视化 GC 日志分析工具</h6><p>打印日志相关参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:$CATALINA_HOME/logs/gc.log -XX:+PrintHeapAtGC -XX:+PrintTenuringDistribution</div><div class="line">例（默认为 ParallelGC, 其它的添加-XX:+UseConcMarkSweepGC或-XX:+UseG1GC即可）：</div><div class="line">JAVA_OPTS=&quot;$JAVA_OPTS -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:$CATALINA_HOME/logs/gc.log&quot;</div><div class="line">CMS日志格式</div><div class="line">G1日志格式</div><div class="line">[在线工具gceasy](http://gceasy.io/)</div><div class="line">访问 GCeasy 官网导入日志即可获取可视化分析及优先建议</div></pre></td></tr></table></figure></p>
<p>GCViewer<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean package -Dmaven.test.skip 生成 jar包，双击执行，导入日志即可进入图形化分析页面</div></pre></td></tr></table></figure></p>
<p>Tomcat 的 GC 调优实战<br>ParallelGC调优<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">设置 Metaspace 大小 -XX:MetaspaceSize=64M -XX:MaxMetaspaceSize=64M</div><div class="line">添加吞吐量和停顿时间参数 -XX:GCTimeRatio=99 -XX:MaxGCPauseMillis=100</div><div class="line">修改动态扩容增量 -XX:YoungGenerationSizeIncrement=30</div></pre></td></tr></table></figure></p>
<p>G1 GC 最佳实践<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-XX:InitiatingHeapOccupancyPercent: Use to change the marking threshold.</div><div class="line">-XX:G1MixedGCLiveThresholdPercent and -XX:G1HeapWastePercent: Use to change the mixed garbage collection decisions.</div><div class="line">-XX:G1MixedGCCountTarget and -XX:G1OldCSetRegionThresholdPercent: Use to adjust the CSet for old regions.</div></pre></td></tr></table></figure></p>
<p><a href="https://docs.oracle.com/javase/9/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304" target="_blank" rel="external">jvm内存调优官方文档</a></p>
<h5 id="7-JAVA代码层调优"><a href="#7-JAVA代码层调优" class="headerlink" title="7.JAVA代码层调优"></a>7.JAVA代码层调优</h5><p>最终代码：monitor_tuning<br> JVM字节码指令与 javap<br>javap <options> <classes><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd monitor_tuning/target/classes/org/alanhou/monitor_tuning/chapter8/</div><div class="line">javap -verbose Test1.class &gt; Test1.txt 即可保存字节码文件</div></pre></td></tr></table></figure></classes></options></p>
<p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4" target="_blank" rel="external">常量池</a><br><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.3.2" target="_blank" rel="external">字段描述符</a><br><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.3.3" target="_blank" rel="external">方法描述符</a><br><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html" target="_blank" rel="external">字节码指令</a><br>i++与++i，字符串拼接+原理<br>javap -verbose SelfAdd.class &gt; SelfAdd.txt<br>通过对 f1()和 f2()的字节码，我们得出结论 i++和++i 的执行效果完全相同<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public static void f1();</div><div class="line">  descriptor: ()V</div><div class="line">  flags: ACC_PUBLIC, ACC_STATIC</div><div class="line">  Code:</div><div class="line">    stack=2, locals=1, args_size=0</div><div class="line">       0: iconst_0</div><div class="line">       1: istore_0</div><div class="line">       2: goto          15</div><div class="line">       5: getstatic     #25                 // Field java/lang/System.out:Ljava/io/PrintStream;</div><div class="line">       8: iload_0</div><div class="line">       9: invokevirtual #31                 // Method java/io/PrintStream.println:(I)V</div><div class="line">      12: iinc          0, 1</div><div class="line">      15: iload_0</div><div class="line">      16: bipush        10</div><div class="line">      18: if_icmplt     5</div><div class="line">      21: return</div></pre></td></tr></table></figure></p>
<p>其他代码优先方法<br>字符串拼接+<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">javap -verbose StringAdd.class &gt;StringAdd.txt</div><div class="line">通过字节码可以看出+拼接符效率要低于 append</div><div class="line">for循环每次要new一个stringbuffer</div></pre></td></tr></table></figure></p>
<p>Try-Finally<br>javap -verbose TryFinally.class &gt;TryFinally.txt<br>Constant variable(final)<br>javap -verbose StringConstant.class &gt;StringConstant.txt<br>jvm是基于栈的架构<br>常用代码优化方法</p>
<ol>
<li>尽量重用对象，不要循环创建对象，比如:for 循环字符串拼接(不在 for中使用+拼接，先new 一个StringBuilder再在 for 里 append)</li>
<li><p>容器类初始化的地时候指定长度（扩容比较耗时）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; collection = new ArrayLIst&lt;String&gt;(5);</div><div class="line">Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;(32);</div></pre></td></tr></table></figure>
</li>
<li><p><strong>ArrayList（底层数组）随机遍历快，LinkedList（底层双向链表）添加删除快只需移动一个指针，hashmap底层数组+链表</strong></p>
</li>
<li>集合遍历尽量减少重复计算</li>
<li><p>使用 Entry 遍历 Map</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">for(Map.Entry&lt;String,String&gt;entry:map.entrySet())&#123;</div><div class="line">    String key=entry.getKey();</div><div class="line">    String value=entry.getValue();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>大数组复制使用System.arraycopy</p>
</li>
<li>尽量使用基本类型而不是包装类型<br>Integer底层使用缓存，因为没有1000没有缓存，所以要new</li>
<li>不要手动调用 System.gc()</li>
<li>及时消除过期对象的引用，防止内存泄漏</li>
<li>尽量使用局部变量，减小变量的作用域</li>
<li>尽量使用非同步的容器ArraryList vs. Vector（建议使用ArraryList）手动加锁</li>
<li>尽量减小同步作用范围, synchronized 方法 vs. 代码块（建议synchronized 方法）</li>
<li>用ThreadLocal 缓存线程不安全的对象，SimpleDateFormat</li>
<li>尽量使用延迟加载</li>
<li>尽量减少使用反射，必须用加缓存</li>
<li>尽量使用连接池、线程池、对象池、缓存</li>
<li>及时释放资源， I/O 流、Socket、数据库连接</li>
<li>慎用异常，不要用抛异常来表示正常的业务逻辑</li>
<li>String 操作尽量少用正则表达式</li>
<li>日志输出注意使用不同的级别</li>
<li>日志中参数拼接使用占位符<br>log.info(“orderId:” + orderId); 不推荐<br>log.info(“orderId:{}”, orderId); 推荐（没有字符串拼接）</li>
</ol>
<p>课程链接：<a href="https://coding.imooc.com/class/241.html" target="_blank" rel="external">https://coding.imooc.com/class/241.html</a></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="https://music.163.com/#/song?id=299258">
            </audio>
        </div>
        
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='c27524ff7fa274a5f47a'
        data-cs='9ca2b17a9a49906b5f3ee758825c4d45a7e4ece4'
        data-r='vipcolud.github.io'
        data-o='vipcolud'
        data-a='vipcolud'
        data-d='false'
    >查看评论</div>


    </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69833742-2', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->


</html>