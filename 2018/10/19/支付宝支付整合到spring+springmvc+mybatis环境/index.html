
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BELONG&#39;s Blog</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="belongapp,"> 
    <meta name="description" content="专注于后端开发,"> 
    <meta name="author" content="BELONG"> 
    <link rel="alternative" href="atom.xml" title="BELONG&#39;s Blog" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?2c17dd32817c94173b19c2a392bb97e9";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">支付宝支付整合到spring+springmvc+mybatis环境</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">支付宝支付整合到spring+springmvc+mybatis环境</h1>
        <div class="stuff">
            <span>十月 19, 2018</span>
            

            <span id="busuanzi_container_page_pv">
            本文总阅读量<span id="busuanzi_value_page_pv"></span>次
            </span>
        </div>
        <div class="content markdown">
            <h1 id="ssm-alipay"><a href="#ssm-alipay" class="headerlink" title="ssm-alipay"></a>ssm-alipay</h1><p>阿里支付宝支付，包括：阿里沙箱环境支付宝测试demo，支付宝支付整合到spring+springmvc+mybatis环境，功能非常齐全，只需要修改对应的配置文件即可，帮助文档齐全！<br><a href="https://github.com/vipcolud/ssm-alipay" target="_blank" rel="external">源码地址</a></p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="一、支付宝测试环境代码测试"><a href="#一、支付宝测试环境代码测试" class="headerlink" title="一、支付宝测试环境代码测试"></a>一、支付宝测试环境代码测试</h3><h4 id="1-下载电脑网站的官方demo："><a href="#1-下载电脑网站的官方demo：" class="headerlink" title="1.下载电脑网站的官方demo："></a>1.下载电脑网站的官方demo：</h4><p>下载地址：<a href="https://docs.open.alipay.com/194/105201/" target="_blank" rel="external">https://docs.open.alipay.com/194/105201/</a><br><img src="下载地址：https://docs.open.alipay.com/194/105201/
![](https://github.com/vipcolud/ssm-alipay/blob/master/img/1.png" alt="在这里插入图片描述">)</p>
<h4 id="2-下载解压导入eclipse"><a href="#2-下载解压导入eclipse" class="headerlink" title="2.下载解压导入eclipse"></a>2.下载解压导入eclipse</h4><p><img src="https://github.com/vipcolud/ssm-alipay/blob/master/img/2.png" alt="">)</p>
<h4 id="3-修改相关配置"><a href="#3-修改相关配置" class="headerlink" title="3.修改相关配置"></a>3.修改相关配置</h4><h6 id="1-进入支付宝沙箱环境："><a href="#1-进入支付宝沙箱环境：" class="headerlink" title="1.进入支付宝沙箱环境："></a>1.进入支付宝沙箱环境：</h6><p><a href="https://openhome.alipay.com/platform/appDaily.htm" target="_blank" rel="external">https://openhome.alipay.com/platform/appDaily.htm</a></p>
<h6 id="2-下载对应版本生成RSA密钥工具："><a href="#2-下载对应版本生成RSA密钥工具：" class="headerlink" title="2.下载对应版本生成RSA密钥工具："></a>2.下载对应版本生成RSA密钥工具：</h6><p><a href="https://docs.open.alipay.com/291/105971" target="_blank" rel="external">https://docs.open.alipay.com/291/105971</a></p>
<h6 id="3-打开工具生成相关的公钥和私钥："><a href="#3-打开工具生成相关的公钥和私钥：" class="headerlink" title="3.打开工具生成相关的公钥和私钥："></a>3.打开工具生成相关的公钥和私钥：</h6><p><img src="https://github.com/vipcolud/ssm-alipay/blob/master/img/3.png" alt="">)</p>
<h6 id="4-将对应的公钥和私钥填入demo的相关配置文件："><a href="#4-将对应的公钥和私钥填入demo的相关配置文件：" class="headerlink" title="4. 将对应的公钥和私钥填入demo的相关配置文件："></a>4. 将对应的公钥和私钥填入demo的相关配置文件：</h6><p><img src="https://github.com/vipcolud/ssm-alipay/blob/master/img/4.png" alt="">)</p>
<h6 id="5-将对应的公钥填入沙箱环境生成相关支付宝公钥以及其他配置填入配置文件："><a href="#5-将对应的公钥填入沙箱环境生成相关支付宝公钥以及其他配置填入配置文件：" class="headerlink" title="5. 将对应的公钥填入沙箱环境生成相关支付宝公钥以及其他配置填入配置文件："></a>5. 将对应的公钥填入沙箱环境生成相关支付宝公钥以及其他配置填入配置文件：</h6><p><img src="https://github.com/vipcolud/ssm-alipay/blob/master/img/5.png" alt="">)</p>
<h4 id="4-运行demo的main方法可以发现支付宝预下单成功-satisfied-satisfied-satisfied-satisfied-satisfied"><a href="#4-运行demo的main方法可以发现支付宝预下单成功-satisfied-satisfied-satisfied-satisfied-satisfied" class="headerlink" title="4.运行demo的main方法可以发现支付宝预下单成功:satisfied::satisfied::satisfied::satisfied::satisfied:"></a>4.运行demo的main方法可以发现支付宝预下单成功:satisfied::satisfied::satisfied::satisfied::satisfied:</h4><p><img src="https://github.com/vipcolud/ssm-alipay/blob/master/img/6.png" alt="">)</p>
<h6 id="1-日志打印出的qr-code就是我们需要的二维码，用相关的二维码生成工具可以生成相对应的二维码"><a href="#1-日志打印出的qr-code就是我们需要的二维码，用相关的二维码生成工具可以生成相对应的二维码" class="headerlink" title="1.日志打印出的qr_code就是我们需要的二维码，用相关的二维码生成工具可以生成相对应的二维码"></a>1.日志打印出的qr_code就是我们需要的二维码，用相关的二维码生成工具可以生成相对应的二维码</h6><p><img src="https://github.com/vipcolud/ssm-alipay/blob/master/img/7.png" alt="">)</p>
<h6 id="2-下载相对应的android版本的沙箱支付宝app扫描二维码可以进行支付-satisfied-satisfied-satisfied-satisfied-satisfied"><a href="#2-下载相对应的android版本的沙箱支付宝app扫描二维码可以进行支付-satisfied-satisfied-satisfied-satisfied-satisfied" class="headerlink" title="2.下载相对应的android版本的沙箱支付宝app扫描二维码可以进行支付:satisfied::satisfied::satisfied::satisfied::satisfied:"></a>2.下载相对应的android版本的沙箱支付宝app扫描二维码可以进行支付:satisfied::satisfied::satisfied::satisfied::satisfied:</h6><p>对应商家和买家账号 <a href="https://openhome.alipay.com/platform/appDaily.htm?tab=account" target="_blank" rel="external">https://openhome.alipay.com/platform/appDaily.htm?tab=account</a><br>沙箱支付宝app <a href="https://openhome.alipay.com/platform/appDaily.htm?tab=tool" target="_blank" rel="external">https://openhome.alipay.com/platform/appDaily.htm?tab=tool</a></p>
<h4 id="3-spring-springmvc-mybatis整合支付宝"><a href="#3-spring-springmvc-mybatis整合支付宝" class="headerlink" title="3.spring+springmvc+mybatis整合支付宝"></a>3.spring+springmvc+mybatis整合支付宝</h4><h6 id="1-建立相关数据表"><a href="#1-建立相关数据表" class="headerlink" title="1.建立相关数据表"></a>1.建立相关数据表</h6><p>用户表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">DROP TABLE IF EXISTS `mmall_user`;</div><div class="line">CREATE TABLE `mmall_user` (</div><div class="line">  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &apos;用户表id&apos;,</div><div class="line">  `username` varchar(50) NOT NULL COMMENT &apos;用户名&apos;,</div><div class="line">  `password` varchar(50) NOT NULL COMMENT &apos;用户密码，MD5加密&apos;,</div><div class="line">  `email` varchar(50) DEFAULT NULL,</div><div class="line">  `phone` varchar(20) DEFAULT NULL,</div><div class="line">  `question` varchar(100) DEFAULT NULL COMMENT &apos;找回密码问题&apos;,</div><div class="line">  `answer` varchar(100) DEFAULT NULL COMMENT &apos;找回密码答案&apos;,</div><div class="line">  `role` int(4) NOT NULL COMMENT &apos;角色0-管理员,1-普通用户&apos;,</div><div class="line">  `create_time` datetime NOT NULL COMMENT &apos;创建时间&apos;,</div><div class="line">  `update_time` datetime NOT NULL COMMENT &apos;最后一次更新时间&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  UNIQUE KEY `user_name_unique` (`username`) USING BTREE</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=utf8;</div></pre></td></tr></table></figure></p>
<p>订单表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">DROP TABLE IF EXISTS `mmall_order`;</div><div class="line">CREATE TABLE `mmall_order` (</div><div class="line">  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &apos;订单id&apos;,</div><div class="line">  `order_no` bigint(20) DEFAULT NULL COMMENT &apos;订单号&apos;,</div><div class="line">  `user_id` int(11) DEFAULT NULL COMMENT &apos;用户id&apos;,</div><div class="line">  `shipping_id` int(11) DEFAULT NULL,</div><div class="line">  `payment` decimal(20,2) DEFAULT NULL COMMENT &apos;实际付款金额,单位是元,保留两位小数&apos;,</div><div class="line">  `payment_type` int(4) DEFAULT NULL COMMENT &apos;支付类型,1-在线支付&apos;,</div><div class="line">  `postage` int(10) DEFAULT NULL COMMENT &apos;运费,单位是元&apos;,</div><div class="line">  `status` int(10) DEFAULT NULL COMMENT &apos;订单状态:0-已取消-10-未付款，20-已付款，40-已发货，50-交易成功，60-交易关闭&apos;,</div><div class="line">  `payment_time` datetime DEFAULT NULL COMMENT &apos;支付时间&apos;,</div><div class="line">  `send_time` datetime DEFAULT NULL COMMENT &apos;发货时间&apos;,</div><div class="line">  `end_time` datetime DEFAULT NULL COMMENT &apos;交易完成时间&apos;,</div><div class="line">  `close_time` datetime DEFAULT NULL COMMENT &apos;交易关闭时间&apos;,</div><div class="line">  `create_time` datetime DEFAULT NULL COMMENT &apos;创建时间&apos;,</div><div class="line">  `update_time` datetime DEFAULT NULL COMMENT &apos;更新时间&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  UNIQUE KEY `order_no_index` (`order_no`) USING BTREE</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=118 DEFAULT CHARSET=utf8;</div></pre></td></tr></table></figure></p>
<p>支付状态表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">DROP TABLE IF EXISTS `mmall_pay_info`;</div><div class="line">CREATE TABLE `mmall_pay_info` (</div><div class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</div><div class="line">  `user_id` int(11) DEFAULT NULL COMMENT &apos;用户id&apos;,</div><div class="line">  `order_no` bigint(20) DEFAULT NULL COMMENT &apos;订单号&apos;,</div><div class="line">  `pay_platform` int(10) DEFAULT NULL COMMENT &apos;支付平台:1-支付宝,2-微信&apos;,</div><div class="line">  `platform_number` varchar(200) DEFAULT NULL COMMENT &apos;支付宝支付流水号&apos;,</div><div class="line">  `platform_status` varchar(20) DEFAULT NULL COMMENT &apos;支付宝支付状态&apos;,</div><div class="line">  `create_time` datetime DEFAULT NULL COMMENT &apos;创建时间&apos;,</div><div class="line">  `update_time` datetime DEFAULT NULL COMMENT &apos;更新时间&apos;,</div><div class="line">  PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=61 DEFAULT CHARSET=utf8;</div></pre></td></tr></table></figure></p>
<h6 id="2-将支付宝sdk相关jar包拷贝到lib目录下、将支付宝相关java文件以及配置文件都拷贝进项目。"><a href="#2-将支付宝sdk相关jar包拷贝到lib目录下、将支付宝相关java文件以及配置文件都拷贝进项目。" class="headerlink" title="2.将支付宝sdk相关jar包拷贝到lib目录下、将支付宝相关java文件以及配置文件都拷贝进项目。"></a>2.将支付宝sdk相关jar包拷贝到lib目录下、将支付宝相关java文件以及配置文件都拷贝进项目。</h6><p><img src="https://github.com/vipcolud/ssm-alipay/blob/master/img/7.png" alt="">)</p>
<h6 id="3-编写相关controller和service"><a href="#3-编写相关controller和service" class="headerlink" title="3.编写相关controller和service"></a>3.编写相关controller和service</h6><p>controller<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">      * 支付pay</div><div class="line">      * @param session</div><div class="line">      * @param orderNo</div><div class="line">      * @param request</div><div class="line">      * @return</div><div class="line">      */</div><div class="line">    @RequestMapping(&quot;pay.do&quot;)</div><div class="line">    @ResponseBody</div><div class="line">    public ServerResponse pay(HttpSession session, Long orderNo, HttpServletRequest request)&#123;</div><div class="line">        User user = (User)session.getAttribute(Const.CURRENT_USER);</div><div class="line">        if(user ==null)&#123;</div><div class="line">            return ServerResponse.createByErrorCodeMessage(ResponseCode.NEED_LOGIN.getCode(),ResponseCode.NEED_LOGIN.getDesc());</div><div class="line">        &#125;</div><div class="line">        String path = request.getSession().getServletContext().getRealPath(&quot;upload&quot;);</div><div class="line">        logger.info(&quot;打印一下路径&quot;+path);</div><div class="line">        return iOrderService.pay(orderNo,user.getId(),path);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @RequestMapping(&quot;alipay_callback.do&quot;)</div><div class="line">    @ResponseBody</div><div class="line">    public Object alipayCallback(HttpServletRequest request)&#123;</div><div class="line">        Map&lt;String,String&gt; params = Maps.newHashMap();</div><div class="line"></div><div class="line">        Map requestParams = request.getParameterMap();</div><div class="line">        for(Iterator iter = requestParams.keySet().iterator();iter.hasNext();)&#123;</div><div class="line">            String name = (String)iter.next();</div><div class="line">            String[] values = (String[]) requestParams.get(name);</div><div class="line">            String valueStr = &quot;&quot;;</div><div class="line">            for(int i = 0 ; i &lt;values.length;i++)&#123;</div><div class="line"></div><div class="line">                valueStr = (i == values.length -1)?valueStr + values[i]:valueStr + values[i]+&quot;,&quot;;</div><div class="line">            &#125;</div><div class="line">            params.put(name,valueStr);</div><div class="line">        &#125;</div><div class="line">        logger.info(&quot;支付宝回调,sign:&#123;&#125;,trade_status:&#123;&#125;,参数:&#123;&#125;&quot;,params.get(&quot;sign&quot;),params.get(&quot;trade_status&quot;),params.toString());</div><div class="line"></div><div class="line">        //非常重要,验证回调的正确性,是不是支付宝发的.并且呢还要避免重复通知.</div><div class="line"></div><div class="line">        params.remove(&quot;sign_type&quot;);</div><div class="line">        try &#123;</div><div class="line">            boolean alipayRSACheckedV2 = AlipaySignature.rsaCheckV2(params, Configs.getAlipayPublicKey(),&quot;utf-8&quot;,Configs.getSignType());</div><div class="line"></div><div class="line">            if(!alipayRSACheckedV2)&#123;</div><div class="line">                return ServerResponse.createByErrorMessage(&quot;非法请求,验证不通过,再恶意请求我就报警找网警了&quot;);</div><div class="line">            &#125;</div><div class="line">        &#125; catch (AlipayApiException e) &#123;</div><div class="line">            logger.error(&quot;支付宝验证回调异常&quot;,e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //todo 验证各种数据</div><div class="line"></div><div class="line"></div><div class="line">        //</div><div class="line">        ServerResponse serverResponse = iOrderService.aliCallback(params);</div><div class="line">        if(serverResponse.isSuccess())&#123;</div><div class="line">            return Const.AlipayCallback.RESPONSE_SUCCESS;</div><div class="line">        &#125;</div><div class="line">        return Const.AlipayCallback.RESPONSE_FAILED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 轮询 查询  支付状态</div><div class="line">     * @param session</div><div class="line">     * @param orderNo</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    @RequestMapping(&quot;query_order_pay_status.do&quot;)</div><div class="line">    @ResponseBody</div><div class="line">    public ServerResponse&lt;Boolean&gt; queryOrderPayStatus(HttpSession session, Long orderNo)&#123;</div><div class="line">        User user = (User)session.getAttribute(Const.CURRENT_USER);</div><div class="line">        if(user ==null)&#123;</div><div class="line">            return ServerResponse.createByErrorCodeMessage(ResponseCode.NEED_LOGIN.getCode(),ResponseCode.NEED_LOGIN.getDesc());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ServerResponse serverResponse = iOrderService.queryOrderPayStatus(user.getId(),orderNo);</div><div class="line">        if(serverResponse.isSuccess())&#123;</div><div class="line">            return ServerResponse.createBySuccess(true);</div><div class="line">        &#125;</div><div class="line">        return ServerResponse.createBySuccess(false);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>service<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div></pre></td><td class="code"><pre><div class="line">public ServerResponse pay(Long orderNo,Integer userId,String path)&#123;</div><div class="line">       Map&lt;String ,String&gt; resultMap = Maps.newHashMap();</div><div class="line">       Order order = orderMapper.selectByUserIdAndOrderNo(userId,orderNo);</div><div class="line">       if(order == null)&#123;</div><div class="line">           return ServerResponse.createByErrorMessage(&quot;用户没有该订单&quot;);</div><div class="line">       &#125;</div><div class="line">       resultMap.put(&quot;orderNo&quot;,String.valueOf(order.getOrderNo()));</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">       // (必填) 商户网站订单系统中唯一订单号，64个字符以内，只能包含字母、数字、下划线，</div><div class="line">       // 需保证商户系统端不能重复，建议通过数据库sequence生成，</div><div class="line">       String outTradeNo = order.getOrderNo().toString();</div><div class="line"></div><div class="line"></div><div class="line">       // (必填) 订单标题，粗略描述用户的支付目的。如“xxx品牌xxx门店当面付扫码消费”</div><div class="line">       String subject = new StringBuilder().append(&quot;happymmall扫码支付,订单号:&quot;).append(outTradeNo).toString();</div><div class="line"></div><div class="line"></div><div class="line">       // (必填) 订单总金额，单位为元，不能超过1亿元</div><div class="line">       // 如果同时传入了【打折金额】,【不可打折金额】,【订单总金额】三者,则必须满足如下条件:【订单总金额】=【打折金额】+【不可打折金额】</div><div class="line">       String totalAmount = order.getPayment().toString();</div><div class="line"></div><div class="line"></div><div class="line">       // (可选) 订单不可打折金额，可以配合商家平台配置折扣活动，如果酒水不参与打折，则将对应金额填写至此字段</div><div class="line">       // 如果该值未传入,但传入了【订单总金额】,【打折金额】,则该值默认为【订单总金额】-【打折金额】</div><div class="line">       String undiscountableAmount = &quot;0&quot;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">       // 卖家支付宝账号ID，用于支持一个签约账号下支持打款到不同的收款账号，(打款到sellerId对应的支付宝账号)</div><div class="line">       // 如果该字段为空，则默认为与支付宝签约的商户的PID，也就是appid对应的PID</div><div class="line">       String sellerId = &quot;&quot;;</div><div class="line"></div><div class="line">       // 订单描述，可以对交易或商品进行一个详细地描述，比如填写&quot;购买商品2件共15.00元&quot;</div><div class="line">       String body = new StringBuilder().append(&quot;订单&quot;).append(outTradeNo).append(&quot;购买商品共&quot;).append(totalAmount).append(&quot;元&quot;).toString();</div><div class="line"></div><div class="line"></div><div class="line">       // 商户操作员编号，添加此参数可以为商户操作员做销售统计</div><div class="line">       String operatorId = &quot;test_operator_id&quot;;</div><div class="line"></div><div class="line">       // (必填) 商户门店编号，通过门店号和商家后台可以配置精准到门店的折扣信息，详询支付宝技术支持</div><div class="line">       String storeId = &quot;test_store_id&quot;;</div><div class="line"></div><div class="line">       // 业务扩展参数，目前可添加由支付宝分配的系统商编号(通过setSysServiceProviderId方法)，详情请咨询支付宝技术支持</div><div class="line">       ExtendParams extendParams = new ExtendParams();</div><div class="line">       extendParams.setSysServiceProviderId(&quot;2088100200300400500&quot;);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">       // 支付超时，定义为120分钟</div><div class="line">       String timeoutExpress = &quot;120m&quot;;</div><div class="line"></div><div class="line">       // 商品明细列表，需填写购买商品详细信息，</div><div class="line">       List&lt;GoodsDetail&gt; goodsDetailList = new ArrayList&lt;GoodsDetail&gt;();</div><div class="line"></div><div class="line">       List&lt;OrderItem&gt; orderItemList = orderItemMapper.getByOrderNoUserId(orderNo,userId);</div><div class="line">       for(OrderItem orderItem : orderItemList)&#123;</div><div class="line">           GoodsDetail goods = GoodsDetail.newInstance(orderItem.getProductId().toString(), orderItem.getProductName(),</div><div class="line">                   BigDecimalUtil.mul(orderItem.getCurrentUnitPrice().doubleValue(),new Double(100).doubleValue()).longValue(),</div><div class="line">                   orderItem.getQuantity());</div><div class="line">           goodsDetailList.add(goods);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // 创建扫码支付请求builder，设置请求参数</div><div class="line">       AlipayTradePrecreateRequestBuilder builder = new AlipayTradePrecreateRequestBuilder()</div><div class="line">               .setSubject(subject).setTotalAmount(totalAmount).setOutTradeNo(outTradeNo)</div><div class="line">               .setUndiscountableAmount(undiscountableAmount).setSellerId(sellerId).setBody(body)</div><div class="line">               .setOperatorId(operatorId).setStoreId(storeId).setExtendParams(extendParams)</div><div class="line">               .setTimeoutExpress(timeoutExpress)</div><div class="line">               .setNotifyUrl(PropertiesUtil.getProperty(&quot;alipay.callback.url&quot;))//支付宝服务器主动通知商户服务器里指定的页面http路径,根据需要设置</div><div class="line">               .setGoodsDetailList(goodsDetailList);</div><div class="line"></div><div class="line"></div><div class="line">       AlipayF2FPrecreateResult result = tradeService.tradePrecreate(builder);</div><div class="line">       switch (result.getTradeStatus()) &#123;</div><div class="line">           case SUCCESS:</div><div class="line">               logger.info(&quot;支付宝预下单成功: )&quot;);</div><div class="line"></div><div class="line">               AlipayTradePrecreateResponse response = result.getResponse();</div><div class="line">               dumpResponse(response);</div><div class="line"></div><div class="line">               /* 上传至ftp服务器</div><div class="line">               File folder = new File(path);</div><div class="line">               if(!folder.exists())&#123;</div><div class="line">                   folder.setWritable(true);</div><div class="line">                   folder.mkdirs();</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               // 需要修改为运行机器上的路径</div><div class="line">               //细节细节细节</div><div class="line">               String qrPath = String.format(path+&quot;/qr-%s.png&quot;,response.getOutTradeNo());</div><div class="line">               String qrFileName = String.format(&quot;qr-%s.png&quot;,response.getOutTradeNo());</div><div class="line">               ZxingUtils.getQRCodeImge(response.getQrCode(), 256, qrPath);</div><div class="line"></div><div class="line">               File targetFile = new File(path,qrFileName);</div><div class="line">               try &#123;</div><div class="line">                   FTPUtil.uploadFile(Lists.newArrayList(targetFile));</div><div class="line">               &#125; catch (IOException e) &#123;</div><div class="line">                   logger.error(&quot;上传二维码异常&quot;,e);</div><div class="line">               &#125;</div><div class="line">               logger.info(&quot;qrPath:&quot; + qrPath);</div><div class="line">               String qrUrl = PropertiesUtil.getProperty(&quot;ftp.server.http.prefix&quot;)+targetFile.getName();</div><div class="line">               resultMap.put(&quot;qrUrl&quot;,qrUrl);</div><div class="line">               return ServerResponse.createBySuccess(resultMap);</div><div class="line">               */</div><div class="line">               // 需要修改为运行机器上的路径    上传到本地</div><div class="line"></div><div class="line">               File folder = new File(path);</div><div class="line">               if(!folder.exists())&#123;</div><div class="line">                   folder.setWritable(true);</div><div class="line">                   folder.mkdirs();</div><div class="line">               &#125;</div><div class="line">               String qrPath = String.format(path+&quot;qr-%s.png&quot;,response.getOutTradeNo());</div><div class="line">               String qrFileName = String.format(&quot;qr-%s.png&quot;,response.getOutTradeNo());</div><div class="line">               ZxingUtils.getQRCodeImge(response.getQrCode(), 256, qrPath);</div><div class="line"></div><div class="line">               logger.info(&quot;filePath:&quot; + qrPath);</div><div class="line">               String qrUrl =qrFileName;</div><div class="line">               resultMap.put(&quot;qrUrl&quot;,qrUrl);</div><div class="line">               return ServerResponse.createBySuccess(resultMap);</div><div class="line">           case FAILED:</div><div class="line">               logger.error(&quot;支付宝预下单失败!!!&quot;);</div><div class="line">               return ServerResponse.createByErrorMessage(&quot;支付宝预下单失败!!!&quot;);</div><div class="line"></div><div class="line">           case UNKNOWN:</div><div class="line">               logger.error(&quot;系统异常，预下单状态未知!!!&quot;);</div><div class="line">               return ServerResponse.createByErrorMessage(&quot;系统异常，预下单状态未知!!!&quot;);</div><div class="line"></div><div class="line">           default:</div><div class="line">               logger.error(&quot;不支持的交易状态，交易返回异常!!!&quot;);</div><div class="line">               return ServerResponse.createByErrorMessage(&quot;不支持的交易状态，交易返回异常!!!&quot;);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   // 简单打印应答</div><div class="line">   private void dumpResponse(AlipayResponse response) &#123;</div><div class="line">       if (response != null) &#123;</div><div class="line">           logger.info(String.format(&quot;code:%s, msg:%s&quot;, response.getCode(), response.getMsg()));</div><div class="line">           if (StringUtils.isNotEmpty(response.getSubCode())) &#123;</div><div class="line">               logger.info(String.format(&quot;subCode:%s, subMsg:%s&quot;, response.getSubCode(),</div><div class="line">                       response.getSubMsg()));</div><div class="line">           &#125;</div><div class="line">           logger.info(&quot;body:&quot; + response.getBody());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   public ServerResponse aliCallback(Map&lt;String,String&gt; params)&#123;</div><div class="line">       Long orderNo = Long.parseLong(params.get(&quot;out_trade_no&quot;));</div><div class="line">       String tradeNo = params.get(&quot;trade_no&quot;);</div><div class="line">       String tradeStatus = params.get(&quot;trade_status&quot;);</div><div class="line">       Order order = orderMapper.selectByOrderNo(orderNo);</div><div class="line">       if(order == null)&#123;</div><div class="line">           return ServerResponse.createByErrorMessage(&quot;非快乐慕商城的订单,回调忽略&quot;);</div><div class="line">       &#125;</div><div class="line">       if(order.getStatus() &gt;= Const.OrderStatusEnum.PAID.getCode())&#123;</div><div class="line">           return ServerResponse.createBySuccess(&quot;支付宝重复调用&quot;);</div><div class="line">       &#125;</div><div class="line">       //判断是否 等待买家付款  交易成功        交易失败</div><div class="line">       if(Const.AlipayCallback.TRADE_STATUS_TRADE_SUCCESS.equals(tradeStatus))&#123;</div><div class="line">           order.setPaymentTime(DateTimeUtil.strToDate(params.get(&quot;gmt_payment&quot;)));</div><div class="line">           order.setStatus(Const.OrderStatusEnum.PAID.getCode());</div><div class="line">           orderMapper.updateByPrimaryKeySelective(order);     //交易成功  改成  已付款</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       PayInfo payInfo = new PayInfo();</div><div class="line">       payInfo.setUserId(order.getUserId());</div><div class="line">       payInfo.setOrderNo(order.getOrderNo());</div><div class="line">       payInfo.setPayPlatform(Const.PayPlatformEnum.ALIPAY.getCode());   //交易平台</div><div class="line">       payInfo.setPlatformNumber(tradeNo);</div><div class="line">       payInfo.setPlatformStatus(tradeStatus);</div><div class="line"></div><div class="line">       payInfoMapper.insert(payInfo);</div><div class="line"></div><div class="line">       return ServerResponse.createBySuccess();</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">   public ServerResponse queryOrderPayStatus(Integer userId,Long orderNo)&#123;</div><div class="line">       Order order = orderMapper.selectByUserIdAndOrderNo(userId,orderNo);</div><div class="line">       if(order == null)&#123;</div><div class="line">           return ServerResponse.createByErrorMessage(&quot;用户没有该订单&quot;);</div><div class="line">       &#125;</div><div class="line">       if(order.getStatus() &gt;= Const.OrderStatusEnum.PAID.getCode())&#123;</div><div class="line">           return ServerResponse.createBySuccess();</div><div class="line">       &#125;</div><div class="line">       return ServerResponse.createByError();</div><div class="line">   &#125;</div><div class="line">   public ServerResponse&lt;PageInfo&gt; manageList(int pageNum,int pageSize)&#123;</div><div class="line">       PageHelper.startPage(pageNum,pageSize);</div><div class="line">       List&lt;Order&gt; orderList = orderMapper.selectAllOrder();</div><div class="line">       List&lt;OrderVo&gt; orderVoList = this.assembleOrderVoList(orderList,null);</div><div class="line">       PageInfo pageResult = new PageInfo(orderList);</div><div class="line">       pageResult.setList(orderVoList);</div><div class="line">       return ServerResponse.createBySuccess(pageResult);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   public ServerResponse&lt;OrderVo&gt; manageDetail(Long orderNo)&#123;</div><div class="line">       Order order = orderMapper.selectByOrderNo(orderNo);</div><div class="line">       if(order != null)&#123;</div><div class="line">           List&lt;OrderItem&gt; orderItemList = orderItemMapper.getByOrderNo(orderNo);</div><div class="line">           OrderVo orderVo = assembleOrderVo(order,orderItemList);</div><div class="line">           return ServerResponse.createBySuccess(orderVo);</div><div class="line">       &#125;</div><div class="line">       return ServerResponse.createByErrorMessage(&quot;订单不存在&quot;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">   public ServerResponse&lt;PageInfo&gt; manageSearch(Long orderNo,int pageNum,int pageSize)&#123;</div><div class="line">       PageHelper.startPage(pageNum,pageSize);</div><div class="line">       Order order = orderMapper.selectByOrderNo(orderNo);</div><div class="line">       if(order != null)&#123;</div><div class="line">           List&lt;OrderItem&gt; orderItemList = orderItemMapper.getByOrderNo(orderNo);</div><div class="line">           OrderVo orderVo = assembleOrderVo(order,orderItemList);</div><div class="line"></div><div class="line">           PageInfo pageResult = new PageInfo(Lists.newArrayList(order));</div><div class="line">           pageResult.setList(Lists.newArrayList(orderVo));</div><div class="line">           return ServerResponse.createBySuccess(pageResult);</div><div class="line">       &#125;</div><div class="line">       return ServerResponse.createByErrorMessage(&quot;订单不存在&quot;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   public ServerResponse&lt;String&gt; manageSendGoods(Long orderNo)&#123;</div><div class="line">       Order order= orderMapper.selectByOrderNo(orderNo);</div><div class="line">       if(order != null)&#123;</div><div class="line">           if(order.getStatus() == Const.OrderStatusEnum.PAID.getCode())&#123;</div><div class="line">               order.setStatus(Const.OrderStatusEnum.SHIPPED.getCode());</div><div class="line">               order.setSendTime(new Date());</div><div class="line">               orderMapper.updateByPrimaryKeySelective(order);</div><div class="line">               return ServerResponse.createBySuccess(&quot;发货成功&quot;);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       return ServerResponse.createByErrorMessage(&quot;订单不存在&quot;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p><a href="https://github.com/vipcolud/ssm-alipay" target="_blank" rel="external">源码地址</a></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="https://music.163.com/#/song?id=299258">
            </audio>
        </div>
        
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='c27524ff7fa274a5f47a'
        data-cs='9ca2b17a9a49906b5f3ee758825c4d45a7e4ece4'
        data-r='vipcolud.github.io'
        data-o='vipcolud'
        data-a='vipcolud'
        data-d='false'
    >查看评论</div>


    </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69833742-2', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->


</html>